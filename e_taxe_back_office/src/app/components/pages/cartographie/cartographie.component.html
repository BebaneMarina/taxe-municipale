<div class="cartographie-page">
  <header class="cartographie-header">
    <app-h1>Cartographie interactive</app-h1>
    <p class="text-gray-600 mt-2">
      Visualisez en temps r√©el les contribuables, collecteurs et zones g√©ographiques de Libreville.
    </p>
  </header>

  <!-- Filtres de recherche -->
  <section class="filters-section" *ngIf="showFilters">
    <div class="filters-container">
      <div class="filters-header">
        <h3>Filtres de recherche</h3>
        <button class="btn-clear" (click)="clearFilters()">R√©initialiser</button>
      </div>
      
      <div class="filters-grid">
        <div class="filter-group">
          <label>Recherche</label>
          <input 
            type="text" 
            [(ngModel)]="searchTerm"
            (input)="applyFilters()"
            placeholder="Nom, pr√©nom, t√©l√©phone, activit√©..."
            class="filter-input"
          >
        </div>

        <div class="filter-group">
          <label>Statut de paiement</label>
          <select 
            [(ngModel)]="filterPaye"
            (change)="applyFilters()"
            class="filter-select"
          >
            <option value="all">Tous</option>
            <option value="paye">Pay√©</option>
            <option value="non-paye">Non pay√©</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Quartier</label>
          <select 
            [(ngModel)]="filterQuartier"
            (change)="applyFilters()"
            class="filter-select"
          >
            <option value="">Tous les quartiers</option>
            <option *ngFor="let quartier of quartiers" [value]="quartier.nom">
              {{ quartier.nom }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label>Collecteur</label>
          <select 
            [(ngModel)]="filterCollecteur"
            (change)="applyFilters()"
            class="filter-select"
          >
            <option value="">Tous les collecteurs</option>
            <option *ngFor="let collecteur of collecteurs" [value]="collecteur.nom + ' ' + collecteur.prenom">
              {{ collecteur.nom }} {{ collecteur.prenom }}
            </option>
          </select>
        </div>
      </div>

      <!-- Statistiques -->
      <div class="stats-summary" *ngIf="getStats()">
        <div class="stat-item">
          <span class="stat-label">Total:</span>
          <span class="stat-value">{{ getStats().total }}</span>
        </div>
        <div class="stat-item stat-paye">
          <span class="stat-label">Pay√©:</span>
          <span class="stat-value">{{ getStats().payes }}</span>
        </div>
        <div class="stat-item stat-non-paye">
          <span class="stat-label">Non pay√©:</span>
          <span class="stat-value">{{ getStats().nonPayes }}</span>
        </div>
        <div class="stat-item stat-filtered">
          <span class="stat-label">Filtr√©:</span>
          <span class="stat-value">{{ getStats().filtered }}</span>
        </div>
      </div>
    </div>
  </section>

  <div class="main-content">
    <!-- Carte -->
    <section class="cartographie-map">
      <app-map-interactive 
        (contribuablesLoaded)="onContribuablesLoaded($event)"
        #mapComponent
      />
    </section>

    <!-- Tableau de r√©sultats -->
    <section class="results-section" *ngIf="showResults">
      <div class="results-container">
        <div class="results-header">
          <h3>R√©sultats ({{ filteredContribuables.length }})</h3>
          <button class="btn-toggle" (click)="toggleResults()">Masquer</button>
        </div>

        <div class="table-container">
          <table class="results-table">
            <thead>
              <tr>
                <th>Contribuable</th>
                <th>T√©l√©phone</th>
                <th>Quartier</th>
                <th>Collecteur</th>
                <th>Statut</th>
                <th>Total Collect√©</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let contrib of paginatedContribuables" 
                  [class.row-paye]="contrib.a_paye"
                  [class.row-non-paye]="!contrib.a_paye">
                <td>
                  <div class="contribuable-info">
                    <strong>{{ contrib.nom }} {{ contrib.prenom || '' }}</strong>
                    <small *ngIf="contrib.nom_activite">{{ contrib.nom_activite }}</small>
                  </div>
                </td>
                <td>{{ contrib.telephone }}</td>
                <td>{{ contrib.quartier || 'N/A' }}</td>
                <td>{{ contrib.collecteur || 'N/A' }}</td>
                <td>
                  <span class="badge" 
                        [class.badge-paye]="contrib.a_paye"
                        [class.badge-non-paye]="!contrib.a_paye">
                    {{ contrib.a_paye ? '‚úì Pay√©' : '‚úó Non pay√©' }}
                  </span>
                </td>
                <td>
                  {{ contrib.total_collecte ? (contrib.total_collecte | number) + ' FCFA' : '-' }}
                </td>
                <td>
                  <button class="btn-zoom" (click)="zoomToContribuable(contrib)" title="Centrer sur la carte">
                    üìç
                  </button>
                </td>
              </tr>
              <tr *ngIf="filteredContribuables.length === 0">
                <td colspan="7" class="no-results">
                  Aucun r√©sultat trouv√©
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" *ngIf="totalPages > 1">
          <button 
            (click)="goToPage(currentPage - 1)"
            [disabled]="currentPage === 1"
            class="btn-page"
          >
            Pr√©c√©dent
          </button>
          <span class="page-info">
            Page {{ currentPage }} / {{ totalPages }}
          </span>
          <button 
            (click)="goToPage(currentPage + 1)"
            [disabled]="currentPage === totalPages"
            class="btn-page"
          >
            Suivant
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- Boutons de contr√¥le -->
  <div class="control-buttons">
    <button class="btn-control" (click)="toggleFilters()">
      {{ showFilters ? 'üîΩ' : 'üîº' }} Filtres
    </button>
    <button class="btn-control" (click)="toggleResults()">
      {{ showResults ? 'üîΩ' : 'üîº' }} R√©sultats
    </button>
  </div>
</div>
